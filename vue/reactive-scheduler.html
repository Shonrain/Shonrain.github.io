<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.19" />
    <style>
      :root {
        --vp-c-bg: #fff;
      }

      [data-theme='dark'] {
        --vp-c-bg: #1b1b1f;
      }

      html,
      body {
        background-color: var(--vp-c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme')
      const systemDarkMode =
        'matchMedia' in window
          ? window.matchMedia('(prefers-color-scheme: dark)').matches
          : false

      if (userMode === 'light') {
        document.documentElement.dataset.theme = 'light'
      } else if (userMode === 'dark' || systemDarkMode) {
        document.documentElement.dataset.theme = 'dark'
      }
    </script>
    <title>ShawDubie</title><meta name="description" content="Shaw`s blog">
    <link rel="preload" href="/assets/style-CkTGTLwf.css" as="style"><link rel="stylesheet" href="/assets/style-CkTGTLwf.css">
    <link rel="modulepreload" href="/assets/app-HaVGcHMr.js"><link rel="modulepreload" href="/assets/reactive-scheduler.html-C_UIMsSQ.js">
    <link rel="prefetch" href="/assets/get-started.html-vk5KMpJ3.js" as="script"><link rel="prefetch" href="/assets/index.html-CnYpaY2H.js" as="script"><link rel="prefetch" href="/assets/day-night-button.html-nZYB4ihx.js" as="script"><link rel="prefetch" href="/assets/architecture-of-play.html-Bh5DyClw.js" as="script"><link rel="prefetch" href="/assets/dependency-injection.html-BRZVZjhv.js" as="script"><link rel="prefetch" href="/assets/dependency-injection2.html-Bs-6NGjz.js" as="script"><link rel="prefetch" href="/assets/first-glance-at-play.html-BTmBOq-9.js" as="script"><link rel="prefetch" href="/assets/know-react.html-CXd9jS0e.js" as="script"><link rel="prefetch" href="/assets/know-redux.html-Cp1jdAPj.js" as="script"><link rel="prefetch" href="/assets/how-to-Handle-collection-in-scala.html-Bqun7eDD.js" as="script"><link rel="prefetch" href="/assets/how-to-use-algebraic-data-type-in-development.html-BZJbGaP-.js" as="script"><link rel="prefetch" href="/assets/mapAndFlatMap.html-D1UOET65.js" as="script"><link rel="prefetch" href="/assets/performance-in-collection.html-CWy2IiUJ.js" as="script"><link rel="prefetch" href="/assets/compile-in-vue-share.html-CXJ8kMKM.js" as="script"><link rel="prefetch" href="/assets/compile-in-vue-share2.html-BiXZm2Dh.js" as="script"><link rel="prefetch" href="/assets/reactive-in-vue.html-Dbc_Y_dq.js" as="script"><link rel="prefetch" href="/assets/share-technology-stack.html-B_iSVYJ9.js" as="script"><link rel="prefetch" href="/assets/reactive-web-application-4.html-Ca81AFYW.js" as="script"><link rel="prefetch" href="/assets/reactive-web-application-5.html-DcBBYjJP.js" as="script"><link rel="prefetch" href="/assets/reactive-web-applications-1.html-BYAUeEBY.js" as="script"><link rel="prefetch" href="/assets/reactive-web-applications-2.html-BoakoXAD.js" as="script"><link rel="prefetch" href="/assets/reactive-web-applications-3.html-DsS6m1G1.js" as="script"><link rel="prefetch" href="/assets/compile-in-vue.html-DpGB868t.js" as="script"><link rel="prefetch" href="/assets/diff-in-vue.html-DITeYh2-.js" as="script"><link rel="prefetch" href="/assets/garbage-collection.html-lo4fyWK1.js" as="script"><link rel="prefetch" href="/assets/glance-renderer.html-Bh1yvHxV.js" as="script"><link rel="prefetch" href="/assets/glance-v8.html-Coyv_778.js" as="script"><link rel="prefetch" href="/assets/glance-vue.html-G-cK_T-t.js" as="script"><link rel="prefetch" href="/assets/optimize-reactive.html-BAMCMqVx.js" as="script"><link rel="prefetch" href="/assets/reactive-array.html-BMNIn_-k.js" as="script"><link rel="prefetch" href="/assets/reactive-collection.html-03n-dp5X.js" as="script"><link rel="prefetch" href="/assets/reactive-in-vue.html-D8UhktEb.js" as="script"><link rel="prefetch" href="/assets/ref-in-vue.html-V0P4ZPX3.js" as="script"><link rel="prefetch" href="/assets/404.html-CcZIlXK6.js" as="script"><link rel="prefetch" href="/assets/Banner-DxHi8yBC.js" as="script"><link rel="prefetch" href="/assets/CompilerDemo-BzzXC7k_.js" as="script"><link rel="prefetch" href="/assets/DayNightButton-DpiqMzxm.js" as="script"><link rel="prefetch" href="/assets/OnlyStar-B-NOZjnZ.js" as="script"><link rel="prefetch" href="/assets/ParseProgress-BShE8s-B.js" as="script"><link rel="prefetch" href="/assets/ReactiveDemo-CxCDSQaE.js" as="script"><link rel="prefetch" href="/assets/Star-qJtzhQjq.js" as="script"><link rel="prefetch" href="/assets/setupDevtools-7MC2TMWH-aRNq5Ox_.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="vp-theme-container external-link-icon" vp-container><!--[--><header class="vp-navbar" vp-navbar><div class="vp-toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a class="route-link" href="/"><!----><span class="vp-site-name" aria-hidden="true">ShawDubie</span></a></span><div class="vp-navbar-items-wrapper" style=""><!--[--><!--]--><!----><!--[--><!--]--><button type="button" class="vp-toggle-color-mode-button" title="toggle color mode"><svg class="light-icon" viewbox="0 0 32 32" style=""><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg class="dark-icon" viewbox="0 0 32 32" style="display:none;"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="vp-sidebar-mask"></div><!--[--><aside class="vp-sidebar" vp-sidebar><!----><!--[--><!--]--><ul class="vp-sidebar-items"><!--[--><li><p tabindex="0" class="vp-sidebar-item vp-sidebar-heading"> <!----></p><!----></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="vp-page"><!--[--><!--]--><div vp-content><!--[--><!--]--><div><h2 class="blog-title">Vue 系列（八）：调度器之 computed 与 watch 的实现</h2><div class="banner" data-v-93e2fed9><img src="https://applets-oss-prod.miyatech.com/cache/miyademmo/image/86bd76f7de584357bdaa40f0e6cdd8a3_4411.png" data-v-93e2fed9><a href="https://mastergo.com/file/99242652305261?page_id=270%3A0262" class="fang" target="_blank" style="left: 36px;bottom: 36px" data-v-93e2fed9> Designed by @吃肉的小羊 </a></div><p>通过前面几篇文章的介绍，整个 <code>Vue</code> 的响应式系统我们就已经了解的差不多了，本篇将是关于响应式系统的最后一篇文章。本篇我们将会介绍 <code>Vue</code> 响应式系统中非常重要的一个部分：<strong>调度器</strong>。</p><h3 id="什么是调度器" tabindex="-1"><a class="header-anchor" href="#什么是调度器"><span>什么是调度器</span></a></h3><br><p>我们当前实现的响应式系统，每当数据发生改变的时候，系统会<strong>自动</strong>去执行副作用函数，比如：</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token comment">// 创建响应式数据</span></span>
<span class="line"><span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span> foo<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 定义副作用函数</span></span>
<span class="line"><span class="token keyword">const</span> <span class="token function-variable function">effectFn</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;data.foo---&gt;&#39;</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>foo<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 注册副作用函数</span></span>
<span class="line"><span class="token function">effect</span><span class="token punctuation">(</span>effectFn<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 修改响应式数据</span></span>
<span class="line"><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> data<span class="token punctuation">.</span>foo <span class="token operator">=</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在上面的例子中，当我们修改 <code>data.foo = 1</code> 的时候，会自动触发副作用函数的执行，如果我们现在要改变副作用函数的执行方式，比如当响应式数据被修改的时候，希望副作用函数能够延迟 1s 执行。当然你可能会说，这还不简单？拿起键盘，直接修改 <code>effectFn</code> 函数，给她加个 <code>setTimeout</code>，一把梭，完事！这当然也是一种办法，但是，我们可不可以在不修改 <code>effectFn</code> 的情况下实现这个需求呢？这就需要我们的响应式系统支持<strong>调度器</strong>了。那什么是调度器呢？</p><p>所谓调度器，就是用户能够自行地去控制副作用函数的执行方式、执行时机等。对于当前我们实现的响应式系统而言，当响应式数据发生变化的时候，我们希望副作用函数能够按照我们规定的方式去执行。那么如何才能<strong>让副作用函数按照我们规定的方式</strong>去执行呢？就是将副作用函数作为一个参数，传递给某个方法，当响应式数据发生变化的时候，就在这个方法中按照我们规定的方式去调用副作用函数即可，而这个方法就是我们即将要实现的<strong>调度器</strong>。</p><p>我们先来看看在 <code>Vue</code> 的响应式系统中调度器是如何被使用的：</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token comment">// 创建响应式数据</span></span>
<span class="line"><span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span> foo<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 定义副作用函数</span></span>
<span class="line"><span class="token keyword">const</span> <span class="token function-variable function">effectFn</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;data.foo---&gt;&#39;</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>foo<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 副作用注册的时候</span></span>
<span class="line"><span class="token function">effect</span><span class="token punctuation">(</span>effectFn<span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token function-variable function">scheduler</span><span class="token operator">:</span> <span class="token punctuation">(</span>fn<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">Function</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">//使用传入的副作用函数</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>通过上面的代码我们可以看到，用户在使用 <code>effect</code> 方法注册副作用函数的时候，新增了一个参数 <code>scheduler</code>，这个参数就是我们所说的调度器，她是一个函数，接收一个方法作为参数。当响应式数据发生变化的时候，会触发 <code>trigger</code> 的执行，在我们之前实现的响应式系统中，我们是直接在 <code>trigger</code> 中执行了相应的副作用函数。有了调度器，则会将副作用函数作为参数传递给调度器，然后执行调度器中的逻辑，这样用户就能手动控制副作用函数的执行了。</p><p>根据上面的分析，要实现调度器，我们首先需要修改 <code>effect</code> 方法：</p><details class="hint-container details"><summary>查看代码</summary><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line highlighted"><span class="token keyword">interface</span> <span class="token class-name">EffectOptions</span> <span class="token punctuation">{</span></span>
<span class="line">  scheduler<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span>fn<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">Function</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">any</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 注册副作用的函数，新增了一个参数 options</span></span>
<span class="line highlighted"><span class="token keyword">const</span> <span class="token function-variable function">effect</span> <span class="token operator">=</span> <span class="token punctuation">(</span>fn<span class="token operator">:</span> <span class="token builtin">Function</span><span class="token punctuation">,</span> options<span class="token operator">?</span><span class="token operator">:</span> EffectOptions<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">const</span> <span class="token function-variable function">effectFn</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">cleanup</span><span class="token punctuation">(</span>effectFn<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    activeEffect <span class="token operator">=</span> effectFn<span class="token punctuation">;</span></span>
<span class="line">    effectStack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>effectFn<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    effectStack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    activeEffect <span class="token operator">=</span> effectStack<span class="token punctuation">[</span>effectStack<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span></span>
<span class="line">    <span class="token keyword">return</span> res<span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  effectFn<span class="token punctuation">.</span>deps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">as</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span>Set<span class="token operator">&lt;</span>EffectFunction<span class="token operator">&gt;&gt;</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">// 给副作用函数增加一个属性 options</span></span>
<span class="line highlighted">  effectFn<span class="token punctuation">.</span>options <span class="token operator">=</span> options<span class="token punctuation">;</span></span>
<span class="line">  <span class="token function">effectFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></details><p>可以看到，我们给 <code>effect</code> 增加了一个参数 <code>options</code>，她的类型是 <code>EffectOptions</code>，用户可以通过该参数定义调度器。当用户通过 <code>effect</code> 注册副作用函数的时候，传入 <code>options</code>，<code>effect</code> 会将 <code>options</code> 挂载到相应的副作用函数上面。除此之外，我们还需要修改 <code>trigger</code> 函数：</p><details class="hint-container details"><summary>查看代码</summary><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token keyword">const</span> <span class="token function-variable function">trigger</span> <span class="token operator">=</span> <span class="token punctuation">(</span>target<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> key<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token builtin">symbol</span><span class="token punctuation">,</span> triggerType<span class="token operator">?</span><span class="token operator">:</span> <span class="token constant">TRIGGER_TYPE</span><span class="token punctuation">,</span> value<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">const</span> depsMap <span class="token operator">=</span> bucket<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>depsMap<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> effectsToRun<span class="token operator">:</span> Set<span class="token operator">&lt;</span>EffectFunction<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 省略其他代码</span></span>
<span class="line"></span>
<span class="line">    effectsToRun<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>fn <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token comment">// 是否有调度器</span></span>
<span class="line highlighted">      <span class="token keyword">if</span> <span class="token punctuation">(</span>fn<span class="token punctuation">.</span>options <span class="token operator">&amp;&amp;</span> fn<span class="token punctuation">.</span>options<span class="token punctuation">.</span>scheduler<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 执行调度器，将副作用函数作为参数传入调度器方法中</span></span>
<span class="line highlighted">        fn<span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">scheduler</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></details><p>在 <code>trigger</code> 方法内，如果某个副作用函数挂载了 <code>options</code>，且 <code>options</code> 中实现了调度器，就不再直接执行该副作用函数了，而是将副作用函数作为参数传递给挂载的 <code>scheduler</code>。这样当 <code>trigger</code> 被触发的时候，响应式系统就会执行用户定义的调度器，这样就实现了对副作用函数的控制。</p><p>那么有了上面我们实现的调度器，我们就可以实现之前的需求了——「希望副作用函数能够延迟 1s 执行」：</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token comment">// 创建响应式数据</span></span>
<span class="line"><span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span> foo<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 定义副作用函数</span></span>
<span class="line"><span class="token keyword">const</span> <span class="token function-variable function">effectFn</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;data.foo---&gt;&#39;</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>foo<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token function">effect</span><span class="token punctuation">(</span>effectFn<span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token function-variable function">scheduler</span><span class="token operator">:</span> <span class="token punctuation">(</span>fn<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">Function</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 通过 setTimeout 控制副作用函数的执行</span></span>
<span class="line highlighted">    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">      fn <span class="token operator">&amp;&amp;</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 修改响应式数据，副作用将会在一秒钟之后执行</span></span>
<span class="line">data<span class="token punctuation">.</span>foo <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在上面的代码中，我们在注册副作用函数的时候实现了一个调度器 <code>scheduler</code>，我们在该调度器内改变了副作用函数的执行时机——即 1s 之后再执行。看到这里你可能会说，实现这么一个简单的需求需要这么多改动，还不如直接一把梭来的快呢。其实调度器的作用远不止于此，<code>Vue</code> 中非常重要的两个能力—— <code>watch</code> 和 <code>computed</code> 就需要依赖调度器来实现。在此之前，我们再来看一个例子以加深对调度器的理解。</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token comment">// 创建响应式数据</span></span>
<span class="line"><span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span> foo<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 定义副作用函数</span></span>
<span class="line"><span class="token keyword">const</span> <span class="token function-variable function">effectFn</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;data.foo---&gt;&#39;</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>foo<span class="token punctuation">)</span><span class="token punctuation">;</span> </span>
<span class="line"></span>
<span class="line"><span class="token comment">// 注册副作用函数</span></span>
<span class="line"><span class="token function">effect</span><span class="token punctuation">(</span>effectFn<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// data.foo---&gt; 0</span></span>
<span class="line"></span>
<span class="line">data<span class="token punctuation">.</span>foo <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// data.foo---&gt; 1</span></span>
<span class="line">data<span class="token punctuation">.</span>foo <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">// data.foo---&gt; 2</span></span>
<span class="line">data<span class="token punctuation">.</span>foo <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token comment">// data.foo---&gt; 3</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在上面的例子中，我们连续修改了 <code>data.foo</code> 的值，可以看到，每次修改都去执行了副作用函数，总共打印了 3 次（不算副作用函数注册时的那次打印）。但是在 <code>Vue</code> 中，如果我们<strong>连续多次</strong>修改了响应式数据，最终只会触发<strong>一次</strong>更新。对于上面的例子来说 <code>data.foo</code> 最终都会被修改成 3，我们其实不需要去关心她的过渡状态，而且多次执行也会影响性能。那么我们就可以通过调度器来让上面的例子只打印 1 次：</p><details class="hint-container details"><summary>查看代码</summary><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token comment">// 创建响应式数据</span></span>
<span class="line"><span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span> foo<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 定义副作用函数</span></span>
<span class="line"><span class="token keyword">const</span> <span class="token function-variable function">effectFn</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;data.foo---&gt;&#39;</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>foo<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// data.foo---&gt; 0</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 是否正在执行的标识</span></span>
<span class="line highlighted"><span class="token keyword">let</span> isInvolving <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token function">effect</span><span class="token punctuation">(</span>effectFn<span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token function-variable function">scheduler</span><span class="token operator">:</span> <span class="token punctuation">(</span>fn<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">Function</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fn<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span></span>
<span class="line highlighted">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isInvolving<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token comment">// 将标识置为 true</span></span>
<span class="line highlighted">      isInvolving <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token comment">// 通过微任务来执行副作用函数</span></span>
<span class="line highlighted">      <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 执行副作用函数</span></span>
<span class="line">        <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// 执行完将标识设为 false</span></span>
<span class="line">        isInvolving <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">data<span class="token punctuation">.</span>foo <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line">data<span class="token punctuation">.</span>foo <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span></span>
<span class="line highlighted">data<span class="token punctuation">.</span>foo <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token comment">// data.foo---&gt; 3</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></details><p>在上面的例子中，我们在调度器中将副作用函数放在一个微任务中进行执行，当其开始执行的时候，我们将标识 <code>isInvolving</code> 置为 <code>true</code>，当微任务执行完毕的时候，将其置为 <code>false</code>。当我们连续 3 次修改 <code>data.foo</code> 的值时，调度器会被执行三次，当第一次执行的时候，<code>isInvolving</code> 会被置为 <code>true</code>，这样后面两次执行的时候，程序就走不到微任务里面去了。那么在这个周期内微任务只会执行一次，即当 <code>data.foo = 3</code> 执行完之后，微任务才会继续执行，此时会执行副作用函数，这样就能做到只打印一次，且打印结果为最终态，即：<code>data.foo---&gt; 3</code>。</p><p>当然 <code>Vue</code> 中实现的调度器要比我们上面的完善许多，但是原理是类似的。</p><h3 id="computed" tabindex="-1"><a class="header-anchor" href="#computed"><span>computed</span></a></h3><br><p><code>computed</code> 是一个非常实用的属性，在日常开发中，我们通过 <code>computed</code> 来处理比较复杂的计算逻辑。在具体实现 <code>computed</code> 之前，我们先来看看她的用法。</p><h5 id="懒执行" tabindex="-1"><a class="header-anchor" href="#懒执行"><span>懒执行</span></a></h5><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token keyword">const</span> foo <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">const</span> bar <span class="token operator">=</span> <span class="token function">computed</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> foo<span class="token punctuation">.</span>value <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;bar---&gt;&#39;</span><span class="token punctuation">,</span> bar<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上面就是一个使用 <code>computed</code> 的例子，我们向 <code>computed</code> 中传递了一个 <code>getter</code>，通过她生成了数据 <code>bar</code>。<code>bar</code> 其实是一个 <code>ref</code>，当访问 <code>bar.value</code> 的时候，就能拿到计算属性的值。这里需要注意的是，当我们通过 <code>computed</code> 定义 <code>bar</code> 时候，<code>computed</code> 并没有立即将 <code>foo.value + 2</code> 的值计算出来，而是返回了一个通过 <code>ref</code> 包裹的方法。当访问 <code>bar.value</code> 时候才会去计算 <code>foo.value + 2</code> 的值。我们称这种方式为<strong>懒（lazy）执行</strong>。这么说可能有些抽象，我们先通过一个例子来看看什么是懒执行。</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token comment">// 创建响应式数据</span></span>
<span class="line"><span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span> foo<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 定义副作用函数</span></span>
<span class="line"><span class="token keyword">const</span> <span class="token function-variable function">effectFn</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;data.foo---&gt;&#39;</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>foo<span class="token punctuation">)</span><span class="token punctuation">;</span> </span>
<span class="line"></span>
<span class="line"><span class="token comment">// 注册副作用函数，effectFn 会立即执行一次</span></span>
<span class="line"><span class="token function">effect</span><span class="token punctuation">(</span>effectFn<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// data.foo---&gt; 0</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在上面的例子，当我们注册副作用函数的时候，副作用函数在注册的时候就会立即执行一次，如果我们不想让她立即执行，而是希望她在被使用的时候执行，比如：</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token comment">// 创建响应式数据</span></span>
<span class="line"><span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span> foo<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 定义副作用函数</span></span>
<span class="line"><span class="token keyword">const</span> <span class="token function-variable function">effectFn</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;data.foo---&gt;&#39;</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>foo<span class="token punctuation">)</span><span class="token punctuation">;</span> </span>
<span class="line"></span>
<span class="line"><span class="token comment">// 注册副作用函数，希望副作用函数不会立即执行</span></span>
<span class="line highlighted"><span class="token keyword">const</span> lazyEffect <span class="token operator">=</span> <span class="token function">effect</span><span class="token punctuation">(</span>effectFn<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 使用的时候才执行</span></span>
<span class="line highlighted"><span class="token function">lazyEffect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// data.foo---&gt; 0</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上面展示的就是一个懒执行的例子，<code>effectFn</code> 被注册的时候不会立即执行，而是当使用她的时候才会执行。那我们要怎么去实现懒执行呢？参考我们实现调度器那样，当副作用函数被注册的时候，我们传一个懒执行的标识，然后根据这个标识去判断是否需要懒执行：</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token comment">// 创建响应式数据</span></span>
<span class="line"><span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span> foo<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 定义副作用函数</span></span>
<span class="line"><span class="token keyword">const</span> <span class="token function-variable function">effectFn</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;data.foo---&gt;&#39;</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>foo<span class="token punctuation">)</span><span class="token punctuation">;</span> </span>
<span class="line"></span>
<span class="line"><span class="token comment">// 注册副作用函数，传入懒执行的标识</span></span>
<span class="line highlighted"><span class="token keyword">const</span> lazyEffect <span class="token operator">=</span> <span class="token function">effect</span><span class="token punctuation">(</span>effectFn<span class="token punctuation">,</span> <span class="token punctuation">{</span> lazy<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 使用的时候才执行</span></span>
<span class="line highlighted"><span class="token function">lazyEffect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// data.foo---&gt; 0</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到，我们给 <code>effect</code> 的 <code>options</code> 中又增加了一个参数 <code>lazy</code>，用来标识是否为懒执行。要实现懒执行，我们还得再观察一下上面的例子，可以看到，当注册副作用函数 <code>effectFn</code> 的时候，<code>effectFn</code> 没有立即执行，而是返回了一个新的函数 <code>lazyEffect</code>，当我们使用 <code>lazyEffect</code> 的时候才会去执行副作用函数。知道了这一点之后，我们就可以实现懒执行了：</p><details class="hint-container details"><summary>查看代码</summary><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token keyword">interface</span> <span class="token class-name">EffectOptions</span> <span class="token punctuation">{</span></span>
<span class="line highlighted">  lazy<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">,</span> <span class="token comment">// 懒执行的标识</span></span>
<span class="line">  scheduler<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span>fn<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">Function</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">any</span> <span class="token comment">// 调度器</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 注册副作用的函数，新增了一个参数 options</span></span>
<span class="line"><span class="token keyword">const</span> <span class="token function-variable function">effect</span> <span class="token operator">=</span> <span class="token punctuation">(</span>fn<span class="token operator">:</span> <span class="token builtin">Function</span><span class="token punctuation">,</span> options<span class="token operator">?</span><span class="token operator">:</span> EffectOptions<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">const</span> <span class="token function-variable function">effectFn</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">cleanup</span><span class="token punctuation">(</span>effectFn<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    activeEffect <span class="token operator">=</span> effectFn<span class="token punctuation">;</span></span>
<span class="line">    effectStack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>effectFn<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    effectStack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    activeEffect <span class="token operator">=</span> effectStack<span class="token punctuation">[</span>effectStack<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span></span>
<span class="line">    <span class="token keyword">return</span> res<span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  effectFn<span class="token punctuation">.</span>deps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">as</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span>Set<span class="token operator">&lt;</span>EffectFunction<span class="token operator">&gt;&gt;</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">// 给副作用函数增加一个属性 options</span></span>
<span class="line">  effectFn<span class="token punctuation">.</span>options <span class="token operator">=</span> options<span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">// 判断是否为懒执行</span></span>
<span class="line highlighted">  <span class="token keyword">if</span> <span class="token punctuation">(</span>options <span class="token operator">&amp;&amp;</span> options<span class="token punctuation">.</span>lazy<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 如果是懒执行，则返回 effectFn</span></span>
<span class="line highlighted">    <span class="token keyword">return</span> effectFn<span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token comment">// 不是懒执行，则立即执行 effectFn</span></span>
<span class="line">  <span class="token function">effectFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></details><p>可以看到，<strong>懒执行的本质其实就是返回一个待执行的函数</strong>。既然知道了什么是懒执行，那么我们就可以着手实现 <code>computed</code> 了：</p><details class="hint-container details"><summary>查看代码</summary><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token keyword">const</span> <span class="token function-variable function">computed</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function-variable function">getter</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">const</span> effectFn <span class="token operator">=</span> <span class="token function">effect</span><span class="token punctuation">(</span>getter<span class="token punctuation">,</span> <span class="token punctuation">{</span> lazy<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">const</span> wrapper <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">get</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">return</span> effectFn <span class="token operator">&amp;&amp;</span> <span class="token function">effectFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token comment">// 添加一个不可枚举且不可修改的属性，用来标识该对象是通过 ref 包裹的</span></span>
<span class="line">  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">,</span> <span class="token string">&#39;__v_isRef&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">    value<span class="token operator">:</span> <span class="token boolean">true</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">// 返回 ref</span></span>
<span class="line">  <span class="token keyword">return</span> wrapper<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></details><p>上面就是 <code>computed</code> 的基本实现，可以看到，非常简单。我们首先定义了一个懒执行的函数 <code>effectFn</code>，由于 <code>computed</code> 返回的是一个 <code>ref</code>，我们可以参考<a class="route-link" href="/vue/ref-in-vue.html">上一篇文章</a>使用一个包裹对象 <code>wrapper</code>。该对象内实现了一个 <code>getter</code>，当访问这个 <code>getter</code> 的时候才会去执行 <code>effectFn</code>。</p><h5 id="缓存" tabindex="-1"><a class="header-anchor" href="#缓存"><span>缓存</span></a></h5><br><p><code>computed</code> 还有一个非常重要的能力——<strong><code>computed</code>是基于她的响应式依赖进行缓存的</strong>，什么意思呢？就是说只有当相关响应式依赖发生改变时，<code>computed</code> 才会重新求值，即执行 <code>getter</code> 中 的 <code>effectFn</code>，否则会返回上一次求值的结果。所以我们需要修改上面的实现：</p><details class="hint-container details"><summary>查看代码</summary><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token keyword">const</span> <span class="token function-variable function">computed</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function-variable function">getter</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment">// 缓存的 value</span></span>
<span class="line highlighted">  <span class="token keyword">let</span> value<span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">// 用来标识响应式依赖是否被修改</span></span>
<span class="line highlighted">  <span class="token keyword">let</span> dirty <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">const</span> effectFn <span class="token operator">=</span> <span class="token function">effect</span><span class="token punctuation">(</span>getter<span class="token punctuation">,</span> <span class="token punctuation">{</span> </span>
<span class="line">    lazy<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line highlighted">    <span class="token function-variable function">scheduler</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>dirty<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 当响应式数据被改变时，将标识置为true</span></span>
<span class="line highlighted">        dirty <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">// 创建一个包裹对象</span></span>
<span class="line">  <span class="token keyword">const</span> wrapper <span class="token operator">=</span> <span class="token punctuation">{</span> </span>
<span class="line">    <span class="token comment">// 只有访问 value 的时候才执行 effectFn</span></span>
<span class="line">    <span class="token keyword">get</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token comment">// dirty 为 true 的时候才去执行副作用函数</span></span>
<span class="line highlighted">      <span class="token keyword">if</span><span class="token punctuation">(</span>dirty<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        value <span class="token operator">=</span> effectFn <span class="token operator">&amp;&amp;</span> <span class="token function">effectFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// 执行完副作用函数后将dirty置为false</span></span>
<span class="line highlighted">        dirty <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">      <span class="token comment">// dirty 为 false 说明数据没有发生改变，直接返回缓存的值</span></span>
<span class="line highlighted">      <span class="token keyword">return</span> value<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token comment">// 添加一个不可枚举且不可修改的属性，用来标识该对象是通过 ref 包裹的</span></span>
<span class="line">  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">,</span> <span class="token string">&#39;__v_isRef&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">    value<span class="token operator">:</span> <span class="token boolean">true</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">// 返回 ref</span></span>
<span class="line">  <span class="token keyword">return</span> wrapper<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></details><p>在上面的代码中，我们首先定义了两个变量：<code>value</code> 和 <code>dirty</code>。<code>value</code> 用来缓存计算属性的值，<code>dirty</code> 则用来标识响应式依赖是否被修改。在使用 <code>effect</code> 时候我们新增了一个调度器 <code>scheduler</code>，她的作用是：当计算属性依赖的响应式数据发生改变的时候，会执行调度器中的代码，也就是将 <code>dirty</code> 置为 <code>true</code>。这样我们就能判断什么时候使用缓存的数据什么时候再次执行副作用函数了。</p><h5 id="副作用嵌套" tabindex="-1"><a class="header-anchor" href="#副作用嵌套"><span>副作用嵌套</span></a></h5><br><p>通过前面的介绍，<code>computed</code> 其实已经实现得比较完善了，但是还存在着一点缺陷，比如下面这个例子：</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token comment">// 创建响应式数据</span></span>
<span class="line"><span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span> foo<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 使用 computed 创建计算属性</span></span>
<span class="line"><span class="token keyword">const</span> bar <span class="token operator">=</span> <span class="token function">computed</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> data<span class="token punctuation">.</span>foo <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 在副作用函数中读取 computed 的值</span></span>
<span class="line"><span class="token keyword">const</span> <span class="token function-variable function">effectFn</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;bar---&gt;&#39;</span><span class="token punctuation">,</span> bar<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 注册副作用函数</span></span>
<span class="line"><span class="token function">effect</span><span class="token punctuation">(</span>effectFn<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment">// 修改响应式数据</span></span>
<span class="line">  data<span class="token punctuation">.</span>foo <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在上面的例子中，我们定义了一个计算属性 <code>bar</code>，该计算属性依赖响应式数据 <code>data.foo</code>，然后我们注册了一个副作用函数 <code>effectFn</code>，该函数会读取 <code>bar.value</code>。如果执行上面的代码，当修改 <code>data.foo = 1</code> 的时候，副作用函数并不会执行。这是因为，我们通过 <code>computed</code> 读取 <code>data.foo</code> 的时候，她只会收集 <code>computed</code> <strong>内部</strong>的副作用函数。当我们通过另一个副作用函数，也就是 <code>effectFn</code> 访问 <code>bar.value</code> 的时候，<code>data.foo</code> 并不能对 <code>effectFn</code> 进行收集，所以我们修改 <code>data.foo = 1</code> 不会触发 <code>effectFn</code> 的执行。</p><p>那要怎么做才能解决上面的问题呢？其实很简单，我们可以将 <code>bar</code> 看作是一个响应式数据，当有副作用函数访问 <code>bar.value</code> 的时候，我们将其收集不就可以了吗？访问 <code>bar.value</code> 不就是访问 <code>computed</code> 中包裹对象 <code>wrapper</code> 的 <code>getter</code> 吗？所以当 <code>wrapper</code> 中的 <code>value</code> 被访问的时候，我们进行副作用函数的收集。那么何时触发执行呢？我们知道，当计算属性依赖的响应式数据发生改变的时候，需要触发执行，也就是修改 <code>dirty</code> 的时候触发执行。经过这样的分析之后，我们再来修改 <code>computed</code>：</p><details class="hint-container details"><summary>查看代码</summary><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token keyword">const</span> <span class="token function-variable function">computed</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function-variable function">getter</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">   <span class="token comment">// 缓存的 value</span></span>
<span class="line">  <span class="token keyword">let</span> value<span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">// 用来标识响应式依赖是否被修改</span></span>
<span class="line">  <span class="token keyword">const</span> effectFn <span class="token operator">=</span> <span class="token function">effect</span><span class="token punctuation">(</span>getter<span class="token punctuation">,</span> <span class="token punctuation">{</span> </span>
<span class="line">    lazy<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token function-variable function">scheduler</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dirty<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 当响应式数据被改变时，将标识置为true</span></span>
<span class="line">        dirty <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// 触发副作用函数</span></span>
<span class="line highlighted">        <span class="token function">trigger</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">,</span> <span class="token string">&#39;value&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">// 创建一个包裹对象</span></span>
<span class="line">  <span class="token keyword">const</span> wrapper <span class="token operator">=</span> <span class="token punctuation">{</span> </span>
<span class="line">    <span class="token comment">// 只有访问 value 的时候才执行 effectFn</span></span>
<span class="line">    <span class="token keyword">get</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">if</span><span class="token punctuation">(</span>dirty<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        value <span class="token operator">=</span> effectFn <span class="token operator">&amp;&amp;</span> <span class="token function">effectFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// 执行完副作用函数后将dirty置为false</span></span>
<span class="line">        dirty <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">      <span class="token comment">// 收集副作用函数</span></span>
<span class="line highlighted">      <span class="token function">track</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">,</span> <span class="token string">&#39;value&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token keyword">return</span> value<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token comment">// 添加一个不可枚举且不可修改的属性，用来标识该对象是通过 ref 包裹的</span></span>
<span class="line">  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">,</span> <span class="token string">&#39;__v_isRef&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">    value<span class="token operator">:</span> <span class="token boolean">true</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">return</span> wrapper<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></details><h3 id="watch" tabindex="-1"><a class="header-anchor" href="#watch"><span>watch</span></a></h3><br><p><code>watch</code> 也是我们在日常开发中经常使用的一个方法，我们通过她来侦听响应式数据的变化，当被侦听的数据发生变化的时候会执行一个自定义的回调方法。同上面介绍 <code>computed</code> 的方法一样，在具体实现 <code>watch</code> 之前，我们还是先来了解一下其基本用法。</p><h5 id="watch-的实现原理" tabindex="-1"><a class="header-anchor" href="#watch-的实现原理"><span>watch 的实现原理</span></a></h5><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token comment">// 定义响应式数据</span></span>
<span class="line"><span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span> foo<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 侦听响应式数据的变化</span></span>
<span class="line"><span class="token function">watch</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token punctuation">(</span>value<span class="token punctuation">,</span> oldValue<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;value---&gt;&#39;</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;oldValue---&gt;&#39;</span><span class="token punctuation">,</span> oldValue<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上面就是一个使用 <code>watch</code> 的例子，可以看到，我们通过 <code>watch</code> 来对响应式数据进行侦听，当响应式数据变化的时候会执行我们定义的回调方法，该方法接收两个参数：<code>value</code> 和 <code>oldValue</code>，分别表示新值和旧值。通过上面的例子我们来分析一下如何去实现 <code>watch</code>。</p><p>对于我们当前的响应式系统来说，当响应式数据变化的时候，会执行被收集的副作用函数，这其实与 <code>watch</code> 比较相似，<code>watch</code> 是响应式数据变化的时候，执行回调方法。那我们可不可以实现，当响应式数据变化的时候，不去执行副作用函数，而是执行回调方法呢？当然可以，通过<strong>调度器</strong>就可以实现这一点，基于此我们先写出如下代码：</p><details class="hint-container details"><summary>查看代码</summary><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token keyword">const</span> <span class="token function-variable function">watch</span> <span class="token operator">=</span> <span class="token punctuation">(</span></span>
<span class="line">  source<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> </span>
<span class="line">  <span class="token function-variable function">callBack</span><span class="token operator">:</span> <span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> oldValue<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span></span>
<span class="line"><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token function">effect</span><span class="token punctuation">(</span></span>
<span class="line">    <span class="token comment">// 访问响应式数据</span></span>
<span class="line">    <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> source<span class="token punctuation">,</span> </span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">      <span class="token function-variable function">scheduler</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 响应式数据变化的时候会执行调度器中的回调函数</span></span>
<span class="line">        <span class="token function">callback</span><span class="token punctuation">(</span>newValue<span class="token punctuation">,</span> oldValue<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span> </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></details><p>上面就是我们根据分析写出的伪代码，这段代码还存在比较多的问题，我们一个一个来分析，首先看 <code>() =&gt; source</code>，这是我们注册的副作用函数，副作用函数只有<strong>读取</strong>响应式数据，才能对其进行收集并触发响应。很显然这样去实现是做不到这一点的，我们还需要实现一个方法去读取 <code>source</code> 中的值：</p><details class="hint-container details"><summary>查看代码</summary><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token keyword">const</span> traverse <span class="token operator">=</span> <span class="token punctuation">(</span>source<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> seen <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment">// 当 source 为 null 或者不是对象的时候直接返回</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>source <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> source <span class="token operator">!==</span> <span class="token string">&#39;object&#39;</span> <span class="token operator">||</span> seen<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token comment">// 将已经访问过的数据添加到 seen 中，如果已经被访问过则不再访问</span></span>
<span class="line">  <span class="token comment">// 防止循环引用产生的无限递归</span></span>
<span class="line">  seen<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">// 遍历 source</span></span>
<span class="line">  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> source<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 递归读取 source 中的元素</span></span>
<span class="line">    <span class="token function">traverse</span><span class="token punctuation">(</span>source<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> seen<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token keyword">return</span> source<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></details><p>我们定义了一个 <code>traverse</code> 方法，她的作用就是帮助副作用函数读取响应式数据中的所有属性，这样就将响应式数据中的所有属性与副作用函数关联起来了，这时当我们修改 <code>source</code> 中的任何一个值的时候就都能触发响应了。完善后的代码如下：</p><details class="hint-container details"><summary>查看代码</summary><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token keyword">const</span> <span class="token function-variable function">watch</span> <span class="token operator">=</span> <span class="token punctuation">(</span></span>
<span class="line">  source<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> </span>
<span class="line">  <span class="token function-variable function">callBack</span><span class="token operator">:</span> <span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> oldValue<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span></span>
<span class="line"><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token function">effect</span><span class="token punctuation">(</span></span>
<span class="line">    <span class="token comment">// 访问响应式数据</span></span>
<span class="line highlighted">    <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">traverse</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">,</span> </span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">      <span class="token function-variable function">scheduler</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 响应式数据变化的时候会执行调度器中的回调函数</span></span>
<span class="line">        <span class="token function">callback</span><span class="token punctuation">(</span>newValue<span class="token punctuation">,</span> oldValue<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span> </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></details><p>上面的代码还存在一个问题，就是回调函数 <code>callBack</code> 需要接收两个参数，分别是新值和旧值。这两个值我们要如何获取呢？我们可以参考 <code>computed</code> 的实现，<code>computed</code> 中缓存的那个 <code>value</code> 其实就是旧值，当响应式数据发生改变的时候重新执行 <code>effectFn</code> 得到的就是新值，基于此，我们可以写出如下代码：</p><details class="hint-container details"><summary>查看代码</summary><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token keyword">const</span> <span class="token function-variable function">watch</span> <span class="token operator">=</span> <span class="token punctuation">(</span></span>
<span class="line">  source<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> </span>
<span class="line">  <span class="token function-variable function">callback</span><span class="token operator">:</span> <span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> oldValue<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span></span>
<span class="line"><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment">// 定义新旧值</span></span>
<span class="line highlighted">  <span class="token keyword">let</span> newValue<span class="token punctuation">,</span> oldValue<span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">const</span> effectFn <span class="token operator">=</span> <span class="token function">effect</span><span class="token punctuation">(</span></span>
<span class="line">    <span class="token comment">// 访问响应式数据</span></span>
<span class="line">    <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">traverse</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line highlighted">      lazy<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 引入懒执行，这样就能拿到副作用函数 effectFn</span></span>
<span class="line">      <span class="token comment">// 当响应式数据变化的时候执行调度器方法</span></span>
<span class="line">      <span class="token function-variable function">scheduler</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 这时重新执行 effectFn 拿到的就是最新的值</span></span>
<span class="line highlighted">        newValue <span class="token operator">=</span> effectFn <span class="token operator">&amp;&amp;</span> <span class="token function">effectFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// 执行回调函数</span></span>
<span class="line">        <span class="token function">callback</span><span class="token punctuation">(</span>newValue<span class="token punctuation">,</span> oldValue<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// 执行完之后将当前的新值赋给旧值</span></span>
<span class="line highlighted">        oldValue <span class="token operator">=</span> newValue<span class="token punctuation">;</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">// 初始化的时候第一次执行effectFn拿到的就是旧值</span></span>
<span class="line highlighted">  oldValue <span class="token operator">=</span> effectFn <span class="token operator">&amp;&amp;</span> <span class="token function">effectFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></details><p>可以看到，为了获取新值和旧值，我们使用了懒执行，其实新旧值的获取和 <code>computed</code> 的思路是差不多的，就是通过 <code>lazy</code> 拿到待执行的 <code>effectFn</code>。新旧值的获取都是通过执行 <code>effectFn</code> 来实现的。需要注意的是，初始化的时候旧值就是第一次调用 <code>effectFn</code> 拿到的，当执行完回调函数的时候，我们还需要将 <code>newValue</code> 赋值给 <code>oldValue</code>。那么现在我们的 <code>watch</code> 就可以正常工作了。但是还存在着一个小问题，就是 <code>watch</code> 接收的第一个参数 <code>source</code>，她不仅可以是对象也有可能是一个 <code>getter</code>：</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span> foo<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> bar<span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token function">watch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> data<span class="token punctuation">.</span>foo<span class="token punctuation">,</span> <span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> oldValue<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;new value-----&gt;&#39;</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;old value-----&gt;&#39;</span><span class="token punctuation">,</span> oldValue<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到，在上面的例子中，我们希望 <code>watch</code> 只对 <code>data.foo</code> 的改变做出响应，要支持 <code>getter</code> 也非常简单：</p><details class="hint-container details"><summary>查看代码</summary><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token keyword">const</span> <span class="token function-variable function">watch</span> <span class="token operator">=</span> <span class="token punctuation">(</span></span>
<span class="line">  source<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> </span>
<span class="line">  <span class="token function-variable function">callback</span><span class="token operator">:</span> <span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> oldValue<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span></span>
<span class="line"><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment">// 定义新旧值</span></span>
<span class="line">  <span class="token keyword">let</span> newValue<span class="token punctuation">,</span> oldValue<span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">// 如果 source 是函数，则直接使用，反之则通过 traverse 进行读取</span></span>
<span class="line highlighted">  <span class="token keyword">const</span> getter <span class="token operator">=</span> <span class="token keyword">typeof</span> source <span class="token operator">===</span> <span class="token string">&#39;function&#39;</span> <span class="token operator">?</span> <span class="token function-variable function">source</span> <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">traverse</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">const</span> effectFn <span class="token operator">=</span> <span class="token function">effect</span><span class="token punctuation">(</span></span>
<span class="line highlighted">    <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">getter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">      lazy<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 引入懒执行，这样就能拿到副作用函数 effectFn</span></span>
<span class="line">      <span class="token comment">// 当响应式数据变化的时候执行调度器方法</span></span>
<span class="line">      <span class="token function-variable function">scheduler</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 这时重新执行 effectFn 拿到的就是最新的值</span></span>
<span class="line">        newValue <span class="token operator">=</span> effectFn <span class="token operator">&amp;&amp;</span> <span class="token function">effectFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// 执行回调函数</span></span>
<span class="line">        <span class="token function">callback</span><span class="token punctuation">(</span>newValue<span class="token punctuation">,</span> oldValue<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// 执行完之后将当前的新值赋给旧值</span></span>
<span class="line">        oldValue <span class="token operator">=</span> newValue<span class="token punctuation">;</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">// 初始化的时候第一次执行effectFn拿到的就是旧值</span></span>
<span class="line">  oldValue <span class="token operator">=</span> effectFn <span class="token operator">&amp;&amp;</span> <span class="token function">effectFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></details><p>可以看到，当 <code>source</code> 为一个函数的时候，我们直接使用该函数作为副作用函数，这样就能支持用户自定义 <code>getter</code> 了。</p><h5 id="立即执行" tabindex="-1"><a class="header-anchor" href="#立即执行"><span>立即执行</span></a></h5><br><p>上面实现的 <code>watch</code> 只支持当响应式数据发生改变的时候，执行回调函数。但是有时候我们需要 <code>watch</code> 在被定义之后就立即执行一次，比如：</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span> foo<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> bar<span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token function">watch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> data<span class="token punctuation">.</span>foo<span class="token punctuation">,</span> <span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> oldValue<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;new value-----&gt;&#39;</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;old value-----&gt;&#39;</span><span class="token punctuation">,</span> oldValue<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> immediate<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// new value-----&gt; 1</span></span>
<span class="line"><span class="token comment">// old value-----&gt; undefined</span></span>
<span class="line"></span>
<span class="line"><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  data<span class="token punctuation">.</span>foo <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// new value-----&gt; 2</span></span>
<span class="line"><span class="token comment">// old value-----&gt; 1</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到，当 <code>watch</code> 被定义之后回调函数立即执行了一次。再次修改响应式数据，回调函数还会再次执行。要实现立即执行也非常简单：</p><details class="hint-container details"><summary>查看代码</summary><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">watch</span> <span class="token operator">=</span> <span class="token punctuation">(</span></span>
<span class="line">  source<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> </span>
<span class="line">  <span class="token function-variable function">callback</span><span class="token operator">:</span> <span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> oldValue<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">,</span></span>
<span class="line highlighted">  options<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">{</span> immediate<span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">let</span> newValue<span class="token punctuation">,</span> oldValue<span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">// 判断是函数还是对象</span></span>
<span class="line">  <span class="token keyword">const</span> getter <span class="token operator">=</span> <span class="token keyword">typeof</span> source <span class="token operator">===</span> <span class="token string">&#39;function&#39;</span> <span class="token operator">?</span> <span class="token function-variable function">source</span> <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">traverse</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">// 将回调的逻辑抽离</span></span>
<span class="line highlighted">  <span class="token keyword">const</span> <span class="token function-variable function">job</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 执行 effectFn 拿到新值</span></span>
<span class="line">    newValue <span class="token operator">=</span> effectFn <span class="token operator">&amp;&amp;</span> <span class="token function">effectFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// 执行回调函数</span></span>
<span class="line">    <span class="token function">callback</span><span class="token punctuation">(</span>newValue<span class="token punctuation">,</span> oldValue<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// 修改旧值</span></span>
<span class="line">    oldValue <span class="token operator">=</span> newValue<span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token keyword">const</span> effectFn <span class="token operator">=</span> <span class="token function">effect</span><span class="token punctuation">(</span></span>
<span class="line">    <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">getter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 访问值</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">      lazy<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// lazy 为true，就可以在获取新值的时候调用 effectFn</span></span>
<span class="line highlighted">      scheduler<span class="token operator">:</span> job </span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>options <span class="token operator">&amp;&amp;</span> options<span class="token punctuation">.</span>immediate<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 如果 immediate 为 true，则立即执行 job</span></span>
<span class="line highlighted">    <span class="token function">job</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 初始化的时候第一次执行effectFn拿到的就是旧值</span></span>
<span class="line">    oldValue <span class="token operator">=</span> effectFn <span class="token operator">&amp;&amp;</span> <span class="token function">effectFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></details><p>可以看到，我们将原来 <code>scheduler</code> 中的逻辑全部抽离了出来，当 <code>immediate</code> 为 <code>true</code> 的时候，立即执行回调的逻辑即可。这里需要注意的是，立即执行时，<code>oldValue</code> 的值是 <code>undefined</code>。</p><h5 id="oncleanup" tabindex="-1"><a class="header-anchor" href="#oncleanup"><span>onCleanup</span></a></h5><br><p>通过前面的介绍，我们知道回调函数 <code>callBack</code> 会接收两个参数 <code>value</code> 和 <code>oldValue</code>。其实在 <code>Vue</code> 中，<code>callBack</code> 还接收第三个参数 <code>onCleanup</code>，该参数是一个方法：</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token function-variable function">oncleanUp</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token function-variable function">fn</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>官方给出的 <code>oncleanUp</code> 的介绍为：</p><blockquote><p>用于注册副作用清理的回调函数。该回调函数会在副作用下一次重新执行前调用，可以用来清除无效的副作用，例如等待中的异步请求</p></blockquote><p>单看这一句描述可能并不太清楚 <code>oncleanUp</code> 有什么作用，我们通过一个例子来解释一下：</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token comment">// 定义响应式数据</span></span>
<span class="line"><span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span> bar<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">// 请求结果</span></span>
<span class="line"><span class="token keyword">let</span> result<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token function">watch</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment">// 调用接口请求数据</span></span>
<span class="line">  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getFoo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">// 修改结果</span></span>
<span class="line">  result <span class="token operator">=</span> res<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 修改响应式数据</span></span>
<span class="line">data<span class="token punctuation">.</span>bar <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span></span>
<span class="line">data<span class="token punctuation">.</span>bar <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如上述代码所示，我们通过 <code>watch</code> 侦听了响应式数据 <code>data</code>，当 <code>data</code> 改变的时候，会调用 <code>geFoo</code> 从服务端获取数据，然后将获取的结果赋值给 <code>result</code>。当我们连续修改 <code>data.bar</code> 的时候，会执行两次回调函数，也就是会发送两次网络请求，这样有可能会导致<strong>竞态问题</strong>的出现：</p><ul><li><p>第一次修改 <code>data.bar = 2</code>，会调用 <code>geFoo</code> 发送请求 <code>A</code>，这时还没有返回请求结果</p></li><li><p>第二次修改 <code>data.bar = 3</code>，会再次调用 <code>geFoo</code> 发送请求 <code>B</code>，这时 <code>A</code>、<code>B</code> 都还没有返回结果</p></li><li><p><code>B</code> 请求优先返回了结果，这时我们执行 <code>result = res</code></p></li><li><p><code>A</code> 请求最后才返回了结果，又要执行 <code>result = res</code>，导致请求 <code>B</code> 的结果被覆盖了。</p></li></ul><p>因为请求 <code>B</code> 是后于 <code>A</code> 发送的，所以我们认为请求 <code>B</code> 得到的结果才是最新的值，而 <code>A</code> 返回的结果应该被清除掉，不应该覆盖 <code>B</code> 的结果。</p><p>我们可以通过一段代码来模拟上面说的场景：</p><details class="hint-container details"><summary>查看代码</summary><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token comment">// 定义 getFoo 来模拟网络请求，传入的 number 为网络请求的响应时间</span></span>
<span class="line"><span class="token keyword">const</span> <span class="token function-variable function">getFoo</span> <span class="token operator">=</span> <span class="token punctuation">(</span>timer<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token builtin">Promise</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">resolve</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span> timer<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 定义响应式数据</span></span>
<span class="line"><span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span> bar<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">// 请求结果</span></span>
<span class="line"><span class="token keyword">let</span> result<span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">// 响应时间</span></span>
<span class="line"><span class="token keyword">let</span> timer <span class="token operator">=</span> <span class="token number">3000</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token function">watch</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment">// 后面请求的响应时间小于前面请求的响应时间</span></span>
<span class="line">  timer <span class="token operator">-=</span> <span class="token number">1000</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getFoo</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  result <span class="token operator">=</span> res<span class="token punctuation">;</span></span>
<span class="line">  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;result---&gt;&#39;</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">data<span class="token punctuation">.</span>bar <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span></span>
<span class="line">data<span class="token punctuation">.</span>bar <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></details><p>在上面的代码中，我们通过 <code>getFoo</code> 来模拟网络请求的场景，她接收一个参数 <code>timer</code>，用来定义返回结果的时间。在 <code>watch</code> 的回调方法中，每次回调都会将 <code>timer</code> 减去 1000，这样后面请求的响应时间就会小于前面请求的响应时间。通过这种方式我们就模拟了上面的例子。那我们要怎么才能解决这个问题呢？</p><p>我们先来分析一下上面的例子，当我们连续修改 <code>data.bar</code> 的时候，会连续调用 <code>watch</code> 的回调方法，即连续通过 <code>getFoo</code> 发送网络请求，每次请求返回的时候，我们都会去修改 <code>result</code> 的值。但是，我们只想要最后一次请求返回的值，在她之前发送的请求，无论什么她们的结果何时返回，我们都希望这些结果被丢弃掉。对于上面的例子来说，发送了两次请求，<strong>当第二次请求发送的时候，我们如果能够让第一次的请求结果被清除掉就好了</strong>。所谓清除，就是在修改 <code>result</code> 的时候增加一个守卫，比如：</p><details class="hint-container details"><summary>查看代码</summary><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token comment">// 定义 getFoo 来模拟网络请求，传入的 number 为网络请求的响应时间</span></span>
<span class="line"><span class="token keyword">const</span> <span class="token function-variable function">getFoo</span> <span class="token operator">=</span> <span class="token punctuation">(</span>timer<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token builtin">Promise</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">resolve</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span> timer<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 定义响应式数据</span></span>
<span class="line"><span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span> bar<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">// 请求结果</span></span>
<span class="line"><span class="token keyword">let</span> result<span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">// 响应时间</span></span>
<span class="line"><span class="token keyword">let</span> timer <span class="token operator">=</span> <span class="token number">3000</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token function">watch</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment">// 后面请求的响应时间小于前面请求的响应时间</span></span>
<span class="line">  timer <span class="token operator">-=</span> <span class="token number">1000</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">// 是否被清除的标识</span></span>
<span class="line highlighted">  <span class="token keyword">let</span> isCleanUp <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line highlighted">  <span class="token comment">// todo, 需要有一个钩子，每次执行回调的时候将上一次的 isCleanUp 置为 true</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getFoo</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">// 增加守卫，如果被清除则不修改 result</span></span>
<span class="line highlighted">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isCleanUp<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    result <span class="token operator">=</span> res<span class="token punctuation">;</span></span>
<span class="line">    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;result---&gt;&#39;</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">data<span class="token punctuation">.</span>bar <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span></span>
<span class="line">data<span class="token punctuation">.</span>bar <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></details><p>在上面的代码中，我们增加了一个变量 <code>isCleanUp</code>，用来标识上一次请求结果是否被清除。如果能够有一个<strong>钩子</strong>，每次执行回调之前，都将上一次的 <code>isCleanUp</code> 置为 <code>true</code> 就好了，这样的话之前的请求结果返回的时候都会被 <code>if(!isCleanUp)</code> 过滤掉。 <code>Vue</code> 恰好提供了这样一个钩子，就是我们前面提到过的 <code>oncleanUp</code>，有了 <code>oncleanUp</code>，我们就可以实现这个需求了：</p><details class="hint-container details"><summary>查看代码</summary><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token keyword">const</span> <span class="token function-variable function">getFoo</span> <span class="token operator">=</span> <span class="token punctuation">(</span>timer<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token builtin">Promise</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">resolve</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span> timer<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span> bar<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">let</span> timer <span class="token operator">=</span> <span class="token number">3000</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token function">watch</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>newValue<span class="token punctuation">,</span> oldValue<span class="token punctuation">,</span> oncleanUp<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  timer <span class="token operator">-=</span> <span class="token number">1000</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">// 是否被清除的标识</span></span>
<span class="line">  <span class="token keyword">let</span> isCleanUp <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">// 通过钩子注册自定义的清除函数</span></span>
<span class="line highlighted">  <span class="token function">oncleanUp</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 将 isCleanUp 修改为 true</span></span>
<span class="line highlighted">    isCleanUp <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getFoo</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">// 增加守卫，如果被清除则不修改 result</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isCleanUp<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    result <span class="token operator">=</span> res<span class="token punctuation">;</span></span>
<span class="line">    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;result---&gt;&#39;</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">data<span class="token punctuation">.</span>bar <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span></span>
<span class="line">data<span class="token punctuation">.</span>bar <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></details><p><code>oncleanUp</code> 的作用就是给用户提供了一个钩子，用户可以通过这个钩子注册一个函数。<strong>当下一次</strong>回调执行之前，会优先执行用户通过钩子注册的函数，然后再去执行回调。注意这里的<strong>下一次</strong>，对于上面的例子来说：</p><ul><li><p>修改 <code>data.bar = 2</code>，首先会判断是否存在上一次通过 <code>oncleanUp</code> 注册的清除函数，因为是第一次，所以不存在清除函数，接下来会执行一次回调，这时候会调用 <code>oncleanUp</code> 注册匿名函数 <code>() =&gt; isCleanUp = true</code></p></li><li><p>再次修改 <code>data.bar = 3</code>，首先会执行<strong>上一次</strong>通过 <code>oncleanUp</code> 注册的匿名函数，也就是执行 <code>() =&gt; isCleanUp = true</code>，这样就将<strong>上一次回调词法环境</strong>中的 <code>isCleanUp</code> 修改为了 <code>true</code>，当上一次回调中的 <code>getFoo(timer)</code> 返回结果的时候，这时 <code>isCleanUp</code> 为 <code>true</code>，就会被 <code>if (!isCleanUp)</code> 过滤掉了。</p></li></ul><p>这里之所以能够通过 <code>oncleanUp</code> 实现清除操作，是因为形成了一个<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Closures" target="_blank" rel="noopener noreferrer">闭包</a>，即通过 <code>oncleanUp</code> 注册的函数读取了外部的变量，对于本例来说，就是匿名函数 <code>() =&gt; isCleanUp = true</code> 读取了定义在外部的变量 <code>isCleanUp</code>。她们共同组成了一个词法环境，这样当下一次回调发生的时候，就能通过注册的函数修改这个词法环境中的变量了。</p><p>既然知道了 <code>oncleanUp</code> 的用法，我们接下来看看如何实现她：</p><details class="hint-container details"><summary>查看代码</summary><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token keyword">const</span> watch <span class="token operator">=</span> <span class="token punctuation">(</span></span>
<span class="line">  source<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> </span>
<span class="line">  callback<span class="token operator">:</span> <span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> oldValue<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> <span class="token function-variable function">oncleanUp</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token function-variable function">fn</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">,</span></span>
<span class="line">  options<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">{</span> immediate<span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">let</span> newValue<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">let</span> oldValue<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">// 用户自定义的清除函数</span></span>
<span class="line highlighted">  <span class="token keyword">let</span> cleanup<span class="token operator">:</span> <span class="token keyword">undefined</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">// 判断是函数还是对象</span></span>
<span class="line">  <span class="token keyword">const</span> getter <span class="token operator">=</span> <span class="token keyword">typeof</span> source <span class="token operator">===</span> <span class="token string">&#39;function&#39;</span> <span class="token operator">?</span> <span class="token function-variable function">source</span> <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">traverse</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">// oncleanUp 钩子，提供给用户注册清除函数</span></span>
<span class="line highlighted">  <span class="token keyword">const</span> <span class="token function-variable function">oncleanUp</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function-variable function">fn</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 将用户自定义的函数赋值给 cleanup</span></span>
<span class="line highlighted">    cleanup <span class="token operator">=</span> fn<span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token comment">// 将回调的逻辑抽离</span></span>
<span class="line">  <span class="token keyword">const</span> <span class="token function-variable function">job</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    newValue <span class="token operator">=</span> effectFn <span class="token operator">&amp;&amp;</span> <span class="token function">effectFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// 如果 cleanup 被注册，则先执行 cleanup</span></span>
<span class="line highlighted">    <span class="token keyword">if</span> <span class="token punctuation">(</span>cleanup<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token comment">// 执行上一次注册的 cleanup</span></span>
<span class="line highlighted">      <span class="token function">cleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token comment">// 执行回调函数，将oncleanUp传给用户使用</span></span>
<span class="line highlighted">    <span class="token function">callback</span><span class="token punctuation">(</span>newValue<span class="token punctuation">,</span> oldValue<span class="token punctuation">,</span> oncleanUp<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// 将旧值改为当前的新值</span></span>
<span class="line">    oldValue <span class="token operator">=</span> newValue<span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token keyword">const</span> effectFn <span class="token operator">=</span> <span class="token function">effect</span><span class="token punctuation">(</span></span>
<span class="line">    <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">getter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 访问值</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">      lazy<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// lazy 为true，就可以在获取新值的时候调用 effectFn</span></span>
<span class="line">      <span class="token function-variable function">scheduler</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">job</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">// 立即执行</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>options <span class="token operator">&amp;&amp;</span> options<span class="token punctuation">.</span>immediate<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">job</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">    oldValue <span class="token operator">=</span> effectFn <span class="token operator">&amp;&amp;</span> <span class="token function">effectFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></details><p>在上面的的代码中，我们增加了一个全局变量 <code>cleanup</code> 用来存储用户注册的清除函数。然后定义了一个名为 <code>oncleanUp</code> 的方法，该方法非常简单，就是将传入的函数赋值给全局变量 <code>cleanup</code>。在 <code>job</code> 中，执行回调函数 <code>callback</code> 之前，会先判断收否有注册的清除函数 <code>cleanup</code>，如果有，则先执行注册的清除函数。在回调函数 <code>callback</code> 中增加了第三个参数 <code>oncleanUp</code>，该方法提供给用户，以便用户能够注册清除函数。</p><p>那么至此，我们就实现了 <code>watch</code> 方法。</p><h3 id="最后" tabindex="-1"><a class="header-anchor" href="#最后"><span>最后</span></a></h3><br><p>本篇我们通过引入调度器的概念来介绍了 <code>Vue</code> 中非常重要的两个功能 <code>computed</code> 和 <code>watch</code>。随着本篇文章的结束，我们关于 <code>Vue</code> 中响应式系统的介绍也就告一段落了。其实 <code>Vue</code> 响应式系统非常复杂，我们在介绍的时候省略了很多细节，只讲解了基本原理，更多细节可以参考 <code>Vue</code> 的<a href="https://github.com/vuejs/core" target="_blank" rel="noopener noreferrer">源码</a>以及社区关于源码解读的文章。本篇文章的代码<a href="https://github.com/Shonrain/vue-demo/blob/main/reactive/scheduler-reactive.ts" target="_blank" rel="noopener noreferrer">请戳</a>。</p></div><!--[--><!--]--></div><footer class="vp-page-meta"><!----><div class="vp-meta-item git-info"><!----><!----></div></footer><!----><!--[--><!--]--></main><!--]--></div><!--[--><!----><!--]--><!--]--></div>
    <script type="module" src="/assets/app-HaVGcHMr.js" defer></script>
  </body>
</html>
